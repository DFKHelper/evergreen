# Vulnerability Fixes - Quick Reference

This document provides copy-paste ready fixes for the security issues identified in the audit.

---

## Fix 1: Add Missing rel="noopener noreferrer"

### File: `/mnt/c/projects/evergreen/evergreen-nextjs/components/Navigation.tsx`

**Line 46-51 - Change from:**
```tsx
<Link
  href="https://evergreenchironash.janeapp.com"
  target="_blank"
  className="flex items-center justify-center px-5 py-2 text-sm font-semibold rounded-xl bg-[#6ff799] text-emerald-900 hover:bg-[#5ce088] transition-all shadow-md"
>
```

**To:**
```tsx
<Link
  href="https://evergreenchironash.janeapp.com"
  target="_blank"
  rel="noopener noreferrer"
  className="flex items-center justify-center px-5 py-2 text-sm font-semibold rounded-xl bg-[#6ff799] text-emerald-900 hover:bg-[#5ce088] transition-all shadow-md"
>
```

**Line 130-134 - Change from:**
```tsx
<Link
  href="https://evergreenchironash.janeapp.com"
  target="_blank"
  className="block px-3 py-2 rounded-xl text-base font-medium text-white bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700"
  onClick={() => setIsOpen(false)}
>
```

**To:**
```tsx
<Link
  href="https://evergreenchironash.janeapp.com"
  target="_blank"
  rel="noopener noreferrer"
  className="block px-3 py-2 rounded-xl text-base font-medium text-white bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700"
  onClick={() => setIsOpen(false)}
>
```

---

### File: `/mnt/c/projects/evergreen/evergreen-nextjs/components/HomePageClient.tsx`

**Line 300-304 - Change from:**
```tsx
<Link
  href={settings?.bookingUrl || 'https://evergreenchironash.janeapp.com'}
  target="_blank"
  className="inline-flex items-center justify-center px-8 py-3 border-2 border-[#6ff799] text-base font-medium rounded-2xl text-white hover:bg-[#6ff799] hover:text-emerald-900 transition-colors shadow-xl"
>
```

**To:**
```tsx
<Link
  href={settings?.bookingUrl || 'https://evergreenchironash.janeapp.com'}
  target="_blank"
  rel="noopener noreferrer"
  className="inline-flex items-center justify-center px-8 py-3 border-2 border-[#6ff799] text-base font-medium rounded-2xl text-white hover:bg-[#6ff799] hover:text-emerald-900 transition-colors shadow-xl"
>
```

---

### File: `/mnt/c/projects/evergreen/evergreen-nextjs/app/page.tsx`

**Line 44-50 - Change from:**
```tsx
<Link
  href={settings?.bookingUrl || 'https://evergreenchironash.janeapp.com'}
  target="_blank"
  className="inline-flex items-center justify-center px-8 py-3 border-2 border-[#6ff799] text-base font-medium rounded-2xl text-white bg-[#6ff799]/20 hover:bg-[#6ff799] hover:text-emerald-900 transition-colors shadow-lg backdrop-blur-sm"
>
```

**To:**
```tsx
<Link
  href={settings?.bookingUrl || 'https://evergreenchironash.janeapp.com'}
  target="_blank"
  rel="noopener noreferrer"
  className="inline-flex items-center justify-center px-8 py-3 border-2 border-[#6ff799] text-base font-medium rounded-2xl text-white bg-[#6ff799]/20 hover:bg-[#6ff799] hover:text-emerald-900 transition-colors shadow-lg backdrop-blur-sm"
>
```

---

## Fix 2: Change HTTP to HTTPS

### File: `/mnt/c/projects/evergreen/evergreen-nextjs/components/CFTPageClient.tsx`

**Line 97 - Change from:**
```tsx
href="http://www.gillespieapproach.com/"
```

**To:**
```tsx
href="https://www.gillespieapproach.com/"
```

---

## Fix 3: Create Error Boundary

### Create new file: `/mnt/c/projects/evergreen/evergreen-nextjs/app/error.tsx`

```tsx
'use client'

import { useEffect } from 'react'

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  useEffect(() => {
    // Log the error to an error reporting service
    console.error(error)
  }, [error])

  return (
    <div className="min-h-screen flex items-center justify-center bg-emerald-900">
      <div className="text-center p-8">
        <h2 className="text-2xl font-bold text-white mb-4">Something went wrong!</h2>
        <p className="text-gray-200 mb-6">We apologize for the inconvenience. Please try again.</p>
        <button
          onClick={() => reset()}
          className="px-6 py-3 bg-[#6ff799] text-emerald-900 font-semibold rounded-2xl hover:bg-[#5ce088] transition-colors"
        >
          Try again
        </button>
      </div>
    </div>
  )
}
```

---

## Fix 4: Add Content Security Policy (Optional Enhancement)

### File: `/mnt/c/projects/evergreen/evergreen-nextjs/next.config.ts`

**Replace entire file with:**
```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  turbopack: {},

  webpack: (config, { dev }) => {
    if (dev) {
      config.watchOptions = {
        poll: 1000,
        aggregateTimeout: 300,
        ignored: /node_modules/,
      };
    }
    return config;
  },

  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'images.squarespace-cdn.com',
      },
    ],
  },

  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin',
          },
          {
            key: 'Permissions-Policy',
            value: 'camera=(), microphone=(), geolocation=()',
          },
        ],
      },
    ];
  },
};

export default nextConfig;
```

---

## Fix 5: Type Safety Improvements

### File: `/mnt/c/projects/evergreen/evergreen-nextjs/lib/types/settings.ts` (Create new file)

```typescript
export interface SiteSettings {
  title?: string;
  tagline?: string;
  description?: string;
  bookingUrl?: string;
  contactPhone?: string;
  contactEmail?: string;
  address?: {
    street?: string;
    city?: string;
    state?: string;
    zip?: string;
  };
}

export interface TeamMember {
  _id: string;
  name: string;
  title: string;
  image?: string;
  instagram?: string;
  bio?: string[] | PortableTextBlock[];
  slug?: { current: string };
}

// Re-export from Sanity for PortableText
import type { PortableTextBlock } from '@portabletext/types';
export type { PortableTextBlock };
```

### Then update HomePageClient.tsx:

```typescript
import type { SiteSettings } from '@/lib/types/settings';

interface HomePageClientProps {
  featuredServices: Service[];
  settings: SiteSettings | null;
}
```

---

## Fix 6: Blog Content Sanitization (Preventive)

### Install DOMPurify:
```bash
npm install dompurify
npm install -D @types/dompurify
```

### File: `/mnt/c/projects/evergreen/evergreen-nextjs/components/BlogPostClient.tsx`

**Add import at top:**
```tsx
import DOMPurify from 'dompurify';
```

**Line 97 - Change from:**
```tsx
dangerouslySetInnerHTML={{ __html: post.content }}
```

**To:**
```tsx
dangerouslySetInnerHTML={{ __html: DOMPurify.sanitize(post.content) }}
```

**Note:** Since this is a client component, DOMPurify will work correctly. For server components, you would need `isomorphic-dompurify`.

---

## Verification Commands

After applying fixes, run:

```bash
# Check for TypeScript errors
npm run lint

# Build to verify no issues
npm run build

# Run a security audit on dependencies
npm audit
```

---

## Summary Checklist

- [ ] Fix 1: Add rel="noopener noreferrer" to 4 links (Navigation, HomePageClient, app/page)
- [ ] Fix 2: Change HTTP to HTTPS in CFTPageClient.tsx
- [ ] Fix 3: Create error.tsx error boundary
- [ ] Fix 4: Add security headers to next.config.ts (optional)
- [ ] Fix 5: Create type definitions and update components (optional)
- [ ] Fix 6: Install and implement DOMPurify for blog content (optional/preventive)

---

*Generated by Security Auditor Agent - 2025-11-21*
